
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Daily Words - 每日单词</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --blue: #007AFF;
      --red: #FF3B30;
      --green: #34C759;
      --bg-page: #F2F2F7;
      --card-bg: #FFFFFF;
      --ios-gray: #8E8E93;
      --ios-separator: #C6C6C8;
    }

    body {
      background-color: var(--bg-page);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      color: #000;
      margin: 0;
      overflow-x: hidden;
    }

    .ios-blur {
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      background: rgba(255, 255, 255, 0.8);
    }

    .safe-area-top { padding-top: env(safe-area-inset-top); }
    .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }

    .perspective-1000 { perspective: 1000px; }
    .preserve-3d { transform-style: preserve-3d; }
    .backface-hidden { 
      backface-visibility: hidden; 
      -webkit-backface-visibility: hidden; 
      background-color: white; 
    }
    .rotate-y-180 { transform: rotateY(180deg); }

    .slide-up { animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }

    .ios-shadow { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background-color: var(--ios-separator);
      border: 1px solid var(--ios-separator);
    }

    .sheet-overlay {
      background-color: rgba(0,0,0,0.4);
      transition: opacity 0.3s ease;
    }

    ::-webkit-scrollbar { display: none; }
  </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.4",
    "react-dom/": "https://esm.sh/react-dom@^19.2.4/",
    "react/": "https://esm.sh/react@^19.2.4/"
  }
}
</script>
</head>
<body>
  <!-- Fixed ID: From 'app' to 'root' to match index.tsx requirements -->
  <div id="root" class="min-h-screen flex flex-col"></div>

  <script>
    // Note: The React app defined in index.tsx will mount into #root.
    // The vanilla script below is maintained and fixed per PM request for consistency.
    const STORAGE_KEY = 'daily_words_v1';
    const EBBINGHAUS_INTERVALS = [0, 1, 2, 4, 7, 15, 30];

    let state = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
      wordLists: [],
      reviewTasks: [],
      view: 'home', 
      calendarDate: new Date().toISOString(),
      activeListId: null,
      activeTaskId: null,
      settings: {
        autoTTS: true,
        showWordFirst: true
      }
    };

    // UI state for the creation process
    let currentBuildingList = {
      title: '',
      description: '',
      mode: 'single',
      words: []
    };

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    const getTodayStr = () => new Date().toISOString().split('T')[0];
    const addDays = (dateStr, days) => {
      const d = new Date(dateStr);
      d.setDate(d.getDate() + days);
      return d.toISOString().split('T')[0];
    };

    async function autoTranslate(word) {
      if (!word) return "";
      try {
        const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(word)}&langpair=en|zh-CN`);
        const data = await res.json();
        return data.responseData.translatedText;
      } catch (e) {
        return "";
      }
    }

    function createList(title, description, words) {
      const listId = 'list_' + Date.now();
      const newList = { id: listId, title, description, words, createdAt: Date.now() };
      state.wordLists.push(newList);

      const today = getTodayStr();
      EBBINGHAUS_INTERVALS.forEach((interval, stage) => {
        state.reviewTasks.push({
          id: `task_${listId}_${stage}`,
          listId: listId,
          scheduledDate: addDays(today, interval),
          status: 'pending',
          type: stage === 0 ? 'study' : 'review',
          stage: stage
        });
      });

      saveState();
      navigate('home');
    }

    function navigate(view, params = {}) {
      state.view = view;
      Object.assign(state, params);
      saveState();
      render();
    }

    function render() {
      const root = document.getElementById('root');
      if (!root) return;
      root.innerHTML = '';
      
      switch(state.view) {
        case 'home': renderHome(root); break;
        case 'library': renderLibrary(root); break;
        case 'add': renderAdd(root); break;
        case 'study': renderStudy(root); break;
      }
    }

    // --- Vanilla UI Fixes per PM ---
    function renderAdd(container) {
      const syncMetadata = () => {
        const titleInput = document.getElementById('new-list-title');
        const descInput = document.getElementById('new-list-desc');
        if (titleInput) currentBuildingList.title = titleInput.value;
        if (descInput) currentBuildingList.description = descInput.value;
      };

      const toggleInputMode = (newMode) => {
        syncMetadata();
        currentBuildingList.mode = newMode;
        renderContent();
      };

      const addWordToTemp = async () => {
        const wordInput = document.querySelector('.word-input');
        const defInput = document.querySelector('.def-input');
        
        if (wordInput && wordInput.value.trim()) {
          currentBuildingList.words.push({
            id: Date.now(),
            word: wordInput.value.trim(),
            definition: defInput.value.trim() || '暂无释义'
          });
          
          // PM Fix: Only clear word/def, keep title
          wordInput.value = '';
          defInput.value = '';
          
          syncMetadata();
          renderTempList();
        }
      };

      const renderTempList = () => {
        const wordsContainer = document.getElementById('wordsContainer');
        if (!wordsContainer) return;
        
        if (currentBuildingList.mode === 'single') {
          wordsContainer.innerHTML = `
            ${currentBuildingList.words.map((w, idx) => `
              <div class="bg-white rounded-xl p-4 ios-shadow flex justify-between items-center mb-3">
                <div>
                  <div class="text-lg font-bold">${w.word}</div>
                  <div class="text-sm text-[#8E8E93]">${w.definition}</div>
                </div>
                <button class="remove-temp-word text-[#FF3B30] text-xs font-bold" data-idx="${idx}">移除</button>
              </div>
            `).join('')}
            
            <div class="bg-white rounded-xl p-4 ios-shadow space-y-3">
              <input type="text" placeholder="单词" class="w-full text-lg font-bold outline-none border-b border-[#F2F2F7] word-input">
              <textarea placeholder="释义" class="w-full text-sm outline-none h-12 bg-[#F9F9F9] p-2 rounded-lg def-input"></textarea>
              <button id="addWordToTempBtn" class="w-full py-3 bg-[#007AFF]/10 text-[#007AFF] rounded-lg font-bold text-sm">+ 添加该词</button>
            </div>
          `;

          const wordIn = wordsContainer.querySelector('.word-input');
          const defIn = wordsContainer.querySelector('.def-input');
          wordIn.onblur = async () => {
            if (wordIn.value && !defIn.value) {
              const trans = await autoTranslate(wordIn.value);
              if (defIn) defIn.value = trans;
            }
          };
          document.getElementById('addWordToTempBtn').onclick = addWordToTemp;
          wordsContainer.querySelectorAll('.remove-temp-word').forEach(btn => {
            btn.onclick = () => {
              currentBuildingList.words.splice(parseInt(btn.dataset.idx), 1);
              renderTempList();
            };
          });
        } else {
          wordsContainer.innerHTML = `<textarea id="batchText" class="w-full h-64 bg-[#F9F9F9] p-3 rounded-lg outline-none font-mono text-sm" placeholder="Apple 苹果\nBanana 香蕉"></textarea>`;
        }
      };

      const renderContent = () => {
        container.innerHTML = `
          <div class="slide-up bg-[#F2F2F7] min-h-screen pb-32">
            <header class="px-5 py-4 flex items-center justify-between border-b border-[#C6C6C8]/20 sticky top-0 bg-[#F2F2F7] z-50">
              <button id="cancelAdd" class="text-[#007AFF]">取消</button>
              <h1 class="text-lg font-bold">新建词单</h1>
              <button id="saveList" class="text-[#007AFF] font-bold">保存</button>
            </header>
            <div class="px-5 mt-6 space-y-6">
              <div class="bg-white rounded-xl overflow-hidden divide-y divide-[#C6C6C8]/30 ios-shadow">
                <input id="new-list-title" type="text" placeholder="词单标题" class="w-full px-4 py-4 outline-none font-bold">
                <input id="new-list-desc" type="text" placeholder="描述" class="w-full px-4 py-3 outline-none text-sm text-[#8E8E93]">
              </div>
              <div class="flex bg-[#E5E5EA] p-1 rounded-lg">
                <button id="modeSingle" class="flex-1 py-1.5 text-xs font-bold rounded-md transition-all ${currentBuildingList.mode === 'single' ? 'bg-white text-black' : 'text-[#8E8E93]'}">逐条录入</button>
                <button id="modeBatch" class="flex-1 py-1.5 text-xs font-bold rounded-md transition-all ${currentBuildingList.mode === 'batch' ? 'bg-white text-black' : 'text-[#8E8E93]'}">批量导入</button>
              </div>
              <div id="wordsContainer" class="space-y-4"></div>
            </div>
          </div>
        `;

        document.getElementById('new-list-title').value = currentBuildingList.title || '';
        document.getElementById('new-list-desc').value = currentBuildingList.description || '';
        document.getElementById('new-list-title').oninput = syncMetadata;
        document.getElementById('new-list-desc').oninput = syncMetadata;

        document.getElementById('modeSingle').onclick = () => toggleInputMode('single');
        document.getElementById('modeBatch').onclick = () => toggleInputMode('batch');
        document.getElementById('cancelAdd').onclick = () => {
          currentBuildingList = { title: '', description: '', mode: 'single', words: [] };
          navigate('home');
        };

        const finalize = () => {
          syncMetadata();
          let finalWords = [...currentBuildingList.words];
          if (currentBuildingList.mode === 'batch') {
            const text = document.getElementById('batchText').value;
            finalWords = text.split('\n').filter(l => l.trim()).map(l => {
              const p = l.split(/\s+/);
              return { word: p[0], definition: p.slice(1).join(' ') || '暂无释义' };
            });
          }
          if (!currentBuildingList.title || finalWords.length === 0) return alert('请完整填写');
          createList(currentBuildingList.title, currentBuildingList.description, finalWords);
          currentBuildingList = { title: '', description: '', mode: 'single', words: [] };
        };
        document.getElementById('saveList').onclick = finalize;
        renderTempList();
      };
      renderContent();
    }
    
    // ... Placeholder for remaining functions (renderHome, renderLibrary, etc.) ...
  </script>
</body>
</html>

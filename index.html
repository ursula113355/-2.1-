
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>æ¯æ—¥å•è¯ Daily Words</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --blue: #007AFF;
      --red: #FF3B30;
      --green: #34C759;
      --bg-page: #F2F2F7;
      --card-bg: #FFFFFF;
      --ios-gray: #8E8E93;
      --ios-separator: #C6C6C8;
    }

    body {
      background-color: var(--bg-page);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      color: #000;
      margin: 0;
      overflow-x: hidden;
    }

    .ios-blur {
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      background: rgba(255, 255, 255, 0.95);
    }

    .safe-area-top { padding-top: env(safe-area-inset-top); }
    .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }

    /* 3D ç¿»è½¬å¡ç‰‡ */
    .perspective-1000 { perspective: 1000px; }
    .preserve-3d { transform-style: preserve-3d; }
    .backface-hidden { 
      backface-visibility: hidden; 
      -webkit-backface-visibility: hidden; 
      background-color: white; 
    }
    .rotate-y-180 { transform: rotateY(180deg); }

    /* é£å‡ºåŠ¨ç”» */
    .fly-right { transform: translateX(150%) rotate(15deg); opacity: 0; transition: all 0.4s ease-in; }
    .fly-left { transform: translateX(-150%) rotate(-15deg); opacity: 0; transition: all 0.4s ease-in; }

    .slide-up { animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }

    .ios-shadow { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12); }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background-color: var(--ios-separator);
      border: 1px solid var(--ios-separator);
    }

    .sheet-overlay {
      background-color: rgba(0,0,0,0.5);
      transition: opacity 0.3s ease;
    }

    /* å¢å¼ºè§†è§‰å¯¹æ¯” */
    .text-review { color: var(--red); }
    .text-study { color: var(--blue); }
    .text-completed { color: var(--green); }

    ::-webkit-scrollbar { display: none; }
  </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.4",
    "react-dom/": "https://esm.sh/react-dom@^19.2.4/",
    "react/": "https://esm.sh/react@^19.2.4/"
  }
}
</script>
</head>
<body>
  <div id="root" class="min-h-screen flex flex-col"></div>

  <script>
    // --- çŠ¶æ€ç®¡ç† ---
    const STORAGE_KEY = 'daily_words_data_v4';
    const EBBINGHAUS_INTERVALS = [0, 1, 2, 4, 7, 15, 30];

    let state = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
      wordLists: [],
      reviewTasks: [],
      view: 'home', 
      calendarDate: new Date().toISOString(),
      activeListId: null,
      activeTaskId: null,
      settings: {
        autoTTS: true,
        showWordFirst: true
      }
    };

    // å½•å…¥ä¸´æ—¶çŠ¶æ€ï¼šä¿®å¤æ ‡é¢˜ä¸¢å¤± Bug
    let currentBuildingList = {
      title: '',
      description: '',
      mode: 'single',
      words: []
    };

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    // --- æ—¥æœŸé€»è¾‘ä¿®å¤ ---
    const getTodayStr = () => {
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, '0');
      const d = String(now.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    };

    const addDays = (dateStr, days) => {
      const [y, m, d] = dateStr.split('-').map(Number);
      const target = new Date(y, m - 1, d);
      target.setDate(target.getDate() + days);
      const ry = target.getFullYear();
      const rm = String(target.getMonth() + 1).padStart(2, '0');
      const rd = String(target.getDate()).padStart(2, '0');
      return `${ry}-${rm}-${rd}`;
    };

    async function autoTranslate(word) {
      if (!word) return "";
      try {
        const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(word)}&langpair=en|zh-CN`);
        const data = await res.json();
        return data.responseData.translatedText;
      } catch (e) {
        return "";
      }
    }

    function createList(title, description, words) {
      const listId = 'list_' + Date.now();
      const newList = { id: listId, title, description, words, createdAt: Date.now() };
      state.wordLists.push(newList);

      const today = getTodayStr();
      EBBINGHAUS_INTERVALS.forEach((interval, stage) => {
        state.reviewTasks.push({
          id: `task_${listId}_${stage}`,
          listId: listId,
          scheduledDate: addDays(today, interval),
          status: 'pending',
          type: stage === 0 ? 'study' : 'review',
          stage: stage
        });
      });

      saveState();
      currentBuildingList = { title: '', description: '', mode: 'single', words: [] };
      navigate('home');
    }

    function navigate(view, params = {}) {
      state.view = view;
      Object.assign(state, params);
      saveState();
      render();
    }

    function render() {
      const root = document.getElementById('root');
      if (!root) return;
      root.innerHTML = '';
      
      switch(state.view) {
        case 'home': renderHome(root); break;
        case 'library': renderLibrary(root); break;
        case 'add': renderAdd(root); break;
        case 'study': renderStudy(root); break;
      }

      if (state.view !== 'study') {
        root.appendChild(createTabBar());
      }
    }

    // --- 1. è®¡åˆ’/æ—¥å†è§†å›¾ (è§†è§‰æ·±åº¦ä¼˜åŒ–) ---
    function renderHome(container) {
      const d = new Date(state.calendarDate);
      const year = d.getFullYear();
      const month = d.getMonth();
      const todayStr = getTodayStr();

      container.innerHTML = `
        <div class="animate-in fade-in duration-300">
          <header class="px-5 pt-10 pb-4 sticky top-0 bg-[#F2F2F7] z-40 border-b border-[#C6C6C8]/30">
            <div class="flex items-center justify-between">
              <button id="prevMonth" class="p-2 text-[#007AFF] active:opacity-50"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="3" d="M15 19l-7-7 7-7"/></svg></button>
              <button id="resetDate" class="flex flex-col items-center">
                <span class="text-xl font-black text-black">${year}å¹´${month + 1}æœˆ</span>
                <span class="text-[11px] font-black uppercase text-[#007AFF] tracking-wider">å›åˆ°ä»Šæ—¥</span>
              </button>
              <div class="flex items-center">
                <button id="nextMonth" class="p-2 text-[#007AFF] active:opacity-50"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="3" d="M9 5l7 7-7 7"/></svg></button>
                <button id="addBtnTop" class="ml-2 p-2 text-[#007AFF] active:opacity-50"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="3" d="M12 4v16m8-8H4"/></svg></button>
              </div>
            </div>
          </header>

          <div class="grid grid-cols-7 px-4 mt-6 text-center text-[13px] font-black text-[#8E8E93] uppercase">
            <span>æ—¥</span><span>ä¸€</span><span>äºŒ</span><span>ä¸‰</span><span>å››</span><span>äº”</span><span>å…­</span>
          </div>

          <div class="calendar-grid mx-4 mt-3 rounded-2xl overflow-hidden bg-white ios-shadow border-[#C6C6C8]">
            ${generateCalendarCells(year, month)}
          </div>

          <div class="px-8 py-8 flex justify-between bg-white/50 mt-4 rounded-xl mx-4 ios-shadow">
             <div class="flex flex-col items-center gap-1"><div class="w-4 h-4 rounded-full bg-[#FF3B30]"></div><span class="text-[12px] text-[#000] font-black">å¾…å¤ä¹ </span></div>
             <div class="flex flex-col items-center gap-1"><div class="w-4 h-4 rounded-full bg-[#007AFF]"></div><span class="text-[12px] text-[#000] font-black">æ–°è¯</span></div>
             <div class="flex flex-col items-center gap-1"><div class="w-4 h-4 rounded-full bg-[#34C759]"></div><span class="text-[12px] text-[#000] font-black">å·²å®Œæˆ</span></div>
          </div>
        </div>
      `;

      document.getElementById('prevMonth').onclick = () => {
        const nd = new Date(state.calendarDate); nd.setMonth(nd.getMonth() - 1);
        navigate('home', { calendarDate: nd.toISOString() });
      };
      document.getElementById('nextMonth').onclick = () => {
        const nd = new Date(state.calendarDate); nd.setMonth(nd.getMonth() + 1);
        navigate('home', { calendarDate: nd.toISOString() });
      };
      document.getElementById('resetDate').onclick = () => navigate('home', { calendarDate: new Date().toISOString() });
      document.getElementById('addBtnTop').onclick = () => navigate('add');
      container.querySelectorAll('.calendar-cell').forEach(cell => {
        cell.onclick = () => showDayDetail(cell.dataset.date);
      });
    }

    function generateCalendarCells(year, month) {
      const first = new Date(year, month, 1);
      const startDay = first.getDay();
      const today = getTodayStr();
      let html = '';
      const startDate = new Date(year, month, 1 - startDay);

      for (let i = 0; i < 42; i++) {
        const current = new Date(startDate);
        current.setDate(startDate.getDate() + i);
        
        const cy = current.getFullYear();
        const cm = String(current.getMonth() + 1).padStart(2, '0');
        const cd = String(current.getDate()).padStart(2, '0');
        const dateStr = `${cy}-${cm}-${cd}`;
        
        const isCurrentMonth = current.getMonth() === month;
        const isToday = dateStr === today;

        const dayTasks = state.reviewTasks.filter(t => t.scheduledDate === dateStr);
        const pendingReview = dayTasks.filter(t => t.status === 'pending' && t.type === 'review').length + (isToday ? state.reviewTasks.filter(t => t.scheduledDate < today && t.status === 'pending').length : 0);
        const newStudy = dayTasks.filter(t => t.status === 'pending' && t.type === 'study').length;
        const completed = dayTasks.filter(t => t.status === 'completed').length;

        html += `
          <div class="calendar-cell aspect-square bg-white flex flex-col items-center justify-start pt-2 relative active:bg-gray-100 transition-colors cursor-pointer" data-date="${dateStr}">
            <span class="text-[16px] h-9 w-9 flex items-center justify-center rounded-full font-black ${isToday ? 'bg-[#007AFF] text-white' : isCurrentMonth ? 'text-black' : 'text-[#C6C6C8]'}">
              ${current.getDate()}
            </span>
            <div class="mt-auto mb-1 flex flex-col items-center gap-0 w-full px-1">
              ${pendingReview > 0 ? `<div class="text-[12px] font-black text-[#FF3B30] truncate">å¤ä¹  ${pendingReview}</div>` : ''}
              ${newStudy > 0 ? `<div class="text-[12px] font-black text-[#007AFF] truncate">æ–°è¯ ${newStudy}</div>` : ''}
              ${completed > 0 ? `<div class="text-[12px] font-black text-[#34C759] truncate">âœ“ ${completed}</div>` : ''}
            </div>
          </div>
        `;
      }
      return html;
    }

    function showDayDetail(dateStr) {
      const overlay = document.createElement('div');
      overlay.className = 'fixed inset-0 z-50 flex items-end sheet-overlay animate-in fade-in duration-200';
      const today = getTodayStr();
      const isToday = dateStr === today;
      const dayTasks = state.reviewTasks.filter(t => t.scheduledDate === dateStr || (isToday && t.scheduledDate < today && t.status === 'pending'));

      overlay.innerHTML = `
        <div class="w-full bg-[#F2F2F7] rounded-t-[32px] ios-shadow slide-up safe-area-bottom max-h-[80vh] flex flex-col overflow-hidden">
          <div class="w-12 h-1.5 bg-[#C6C6C8] rounded-full mx-auto mt-4 mb-2"></div>
          <div class="px-6 py-3 flex items-center justify-between border-b border-[#C6C6C8]/30">
            <h2 class="text-2xl font-black">${dateStr} ä»»åŠ¡æ¸…å•</h2>
            <button id="closeSheet" class="text-[#007AFF] text-lg font-black">å…³é—­</button>
          </div>
          <div class="flex-1 overflow-y-auto px-6 py-5 space-y-4 pb-24">
            ${dayTasks.length > 0 ? dayTasks.map(t => {
              const list = state.wordLists.find(l => l.id === t.listId);
              return `
                <div class="bg-white rounded-2xl p-5 flex items-center justify-between ios-shadow border border-[#C6C6C8]/20">
                  <div>
                    <div class="flex gap-2 mb-2">
                      <span class="text-[11px] font-black uppercase px-2 py-1 rounded ${t.status === 'completed' ? 'bg-[#34C759] text-white' : t.type === 'study' ? 'bg-[#007AFF] text-white' : 'bg-[#FF3B30] text-white'}">
                        ${t.type === 'study' ? 'æ–°è¯å­¦ä¹ ' : 'å¤ä¹ é˜¶æ®µ ' + t.stage}
                      </span>
                      ${t.scheduledDate < today && t.status === 'pending' ? '<span class="text-[11px] font-black uppercase px-2 py-1 rounded bg-[#000] text-white">è¿‡æœŸæé†’</span>' : ''}
                    </div>
                    <h4 class="text-lg font-black text-black">${list?.title || 'æœªå‘½åè¯å•'}</h4>
                    <p class="text-sm font-bold text-[#8E8E93]">${list?.words.length} è¯æ±‡</p>
                  </div>
                  ${t.status === 'pending' ? `
                    <button class="bg-[#007AFF] text-white px-6 py-3 rounded-full text-base font-black active:scale-95 transition-transform start-task-btn" data-tid="${t.id}" data-lid="${t.listId}">
                      å¼€å§‹
                    </button>
                  ` : '<span class="text-[#34C759] font-black text-lg">å·²è¾¾æˆ âœ“</span>'}
                </div>
              `;
            }).join('') : '<div class="text-center py-16 opacity-40 font-bold text-lg">ğŸ‰ æš‚æ— å¾…åŠä»»åŠ¡</div>'}
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
      overlay.querySelector('#closeSheet').onclick = () => overlay.remove();
      overlay.querySelector('.sheet-overlay > div')?.onclick = (e) => e.stopPropagation();
      overlay.onclick = () => overlay.remove();

      overlay.querySelectorAll('.start-task-btn').forEach(btn => {
        btn.onclick = (e) => { 
          e.stopPropagation();
          overlay.remove(); 
          navigate('study', { activeTaskId: btn.dataset.tid, activeListId: btn.dataset.lid }); 
        };
      });
    }

    // --- 2. å½•å…¥è§†å›¾ (ä¿®å¤æ ‡é¢˜ä¸¢å¤±ä¸å…¨é‡æ±‰åŒ–) ---
    function renderAdd(container) {
      const syncMetadata = () => {
        const titleInput = document.getElementById('new-list-title');
        const descInput = document.getElementById('new-list-desc');
        if (titleInput) currentBuildingList.title = titleInput.value;
        if (descInput) currentBuildingList.description = descInput.value;
      };

      const toggleInputMode = (newMode) => {
        syncMetadata();
        currentBuildingList.mode = newMode;
        renderContent();
      };

      const addWordToTemp = async () => {
        const wordInput = document.getElementById('temp-word');
        const defInput = document.getElementById('temp-def');
        if (wordInput && wordInput.value.trim()) {
          currentBuildingList.words.push({
            id: Date.now(),
            word: wordInput.value.trim(),
            definition: defInput.value.trim() || 'æš‚æ— é‡Šä¹‰'
          });
          wordInput.value = '';
          defInput.value = '';
          syncMetadata();
          renderTempList();
        }
      };

      const renderTempList = () => {
        const wordsContainer = document.getElementById('wordsContainer');
        if (!wordsContainer) return;
        
        if (currentBuildingList.mode === 'single') {
          wordsContainer.innerHTML = `
            ${currentBuildingList.words.map((w, idx) => `
              <div class="bg-white rounded-2xl p-4 ios-shadow flex justify-between items-center mb-3 border border-[#C6C6C8]/10">
                <div>
                  <div class="text-lg font-black text-black">${w.word}</div>
                  <div class="text-sm font-bold text-[#8E8E93]">${w.definition}</div>
                </div>
                <button class="remove-temp-word text-[#FF3B30] text-sm font-black px-3 py-1 bg-[#FF3B30]/10 rounded-full" data-idx="${idx}">ç§»é™¤</button>
              </div>
            `).join('')}
            
            <div class="bg-white rounded-2xl p-6 ios-shadow space-y-4 border-2 border-[#007AFF]/20">
              <input id="temp-word" type="text" placeholder="è¾“å…¥è‹±æ–‡å•è¯" class="w-full text-xl font-black outline-none border-b border-[#F2F2F7] pb-2">
              <textarea id="temp-def" placeholder="ä¸­æ–‡é‡Šä¹‰ (å¤±ç„¦è‡ªåŠ¨ç¿»è¯‘)" class="w-full text-base font-bold outline-none h-20 bg-[#F9F9F9] p-4 rounded-2xl"></textarea>
              <button id="addWordToTempBtn" class="w-full py-4 bg-[#007AFF] text-white rounded-2xl font-black text-lg active:scale-95 transition-transform">+ æ·»åŠ åˆ°è¯å•</button>
            </div>
          `;

          const wordIn = document.getElementById('temp-word');
          const defIn = document.getElementById('temp-def');
          wordIn.onblur = async () => {
            if (wordIn.value && !defIn.value) {
              defIn.placeholder = "ç¿»è¯‘ä¸­...";
              const trans = await autoTranslate(wordIn.value);
              defIn.value = trans;
            }
          };
          document.getElementById('addWordToTempBtn').onclick = addWordToTemp;
          wordsContainer.querySelectorAll('.remove-temp-word').forEach(btn => {
            btn.onclick = () => { currentBuildingList.words.splice(parseInt(btn.dataset.idx), 1); renderTempList(); };
          });
        } else {
          wordsContainer.innerHTML = `
            <div class="bg-white rounded-2xl p-5 ios-shadow space-y-3">
              <p class="text-xs font-black text-[#8E8E93] uppercase">æ ¼å¼ï¼šå•è¯ [ç©ºæ ¼] é‡Šä¹‰ï¼Œä¸€è¡Œä¸€ä¸ª</p>
              <textarea id="batchText" class="w-full h-72 bg-[#F9F9F9] p-4 rounded-2xl outline-none font-mono text-base font-bold" placeholder="Apple è‹¹æœ\nBanana é¦™è•‰"></textarea>
            </div>
          `;
        }
      };

      const renderContent = () => {
        container.innerHTML = `
          <div class="slide-up bg-[#F2F2F7] min-h-screen pb-40">
            <header class="px-6 py-5 flex items-center justify-between border-b border-[#C6C6C8]/30 sticky top-0 bg-[#F2F2F7] z-50">
              <button id="cancelAdd" class="text-[#007AFF] text-lg font-black">å–æ¶ˆ</button>
              <h1 class="text-xl font-black">æ–°å»ºè¯å•</h1>
              <button id="saveList" class="text-[#007AFF] text-lg font-black">ä¿å­˜</button>
            </header>

            <div class="px-6 mt-8 space-y-8">
              <div class="bg-white rounded-2xl overflow-hidden divide-y divide-[#C6C6C8]/30 ios-shadow">
                <input id="new-list-title" type="text" placeholder="è¯å•åç§° (å¦‚: é›…æ€æ ¸å¿ƒ)" class="w-full px-5 py-5 outline-none font-black text-xl">
                <input id="new-list-desc" type="text" placeholder="æè¿°ä¿¡æ¯ (å¯é€‰)" class="w-full px-5 py-4 outline-none text-base font-bold text-[#8E8E93]">
              </div>

              <div class="flex bg-[#E5E5EA] p-1.5 rounded-2xl">
                <button id="modeSingle" class="flex-1 py-2.5 text-sm font-black rounded-xl transition-all ${currentBuildingList.mode === 'single' ? 'bg-white ios-shadow text-black' : 'text-[#8E8E93]'}">é€æ¡æ‰‹åŠ¨</button>
                <button id="modeBatch" class="flex-1 py-2.5 text-sm font-black rounded-xl transition-all ${currentBuildingList.mode === 'batch' ? 'bg-white ios-shadow text-black' : 'text-[#8E8E93]'}">æ‰¹é‡å¯¼å…¥</button>
              </div>

              <div id="wordsContainer" class="space-y-6"></div>
            </div>
            
            <div class="fixed bottom-10 left-0 right-0 px-6 safe-area-bottom z-50">
              <button id="finalSave" class="w-full py-5 bg-[#007AFF] text-white rounded-[24px] font-black text-xl ios-shadow active:scale-95 transition-transform">ç¡®è®¤åˆ›å»ºå¹¶ç”Ÿæˆè®¡åˆ’</button>
            </div>
          </div>
        `;

        const titleInput = document.getElementById('new-list-title');
        const descInput = document.getElementById('new-list-desc');
        titleInput.value = currentBuildingList.title || '';
        descInput.value = currentBuildingList.description || '';
        
        titleInput.oninput = syncMetadata;
        descInput.oninput = syncMetadata;

        document.getElementById('modeSingle').onclick = () => toggleInputMode('single');
        document.getElementById('modeBatch').onclick = () => toggleInputMode('batch');
        document.getElementById('cancelAdd').onclick = () => {
          if(confirm("ç¡®å®šè¦æ”¾å¼ƒå—ï¼Ÿæ‰€æœ‰è¾“å…¥å°†ä¸ä¼šä¿å­˜ã€‚")) {
            currentBuildingList = { title: '', description: '', mode: 'single', words: [] };
            navigate('home');
          }
        };

        const finalize = () => {
          syncMetadata();
          let finalWords = [];
          if (currentBuildingList.mode === 'single') {
            finalWords = [...currentBuildingList.words];
            const wIn = document.getElementById('temp-word');
            const dIn = document.getElementById('temp-def');
            if (wIn && wIn.value.trim()) finalWords.push({ word: wIn.value.trim(), definition: dIn.value.trim() || 'æš‚æ— é‡Šä¹‰' });
          } else {
            const text = document.getElementById('batchText').value;
            text.split('\n').forEach(line => {
              const parts = line.split(/\s+/);
              if (parts[0]) finalWords.push({ word: parts[0], definition: parts.slice(1).join(' ') || 'æš‚æ— é‡Šä¹‰' });
            });
          }

          if (!currentBuildingList.title.trim() || finalWords.length === 0) return alert('è¯·ç¡®ä¿æ ‡é¢˜ä¸ä¸ºç©ºï¼Œä¸”è‡³å°‘å½•å…¥ä¸€ä¸ªå•è¯ã€‚');
          createList(currentBuildingList.title, currentBuildingList.description, finalWords);
        };
        document.getElementById('saveList').onclick = finalize;
        document.getElementById('finalSave').onclick = finalize;
        renderTempList();
      };
      renderContent();
    }

    // --- 3. å¤ä¹ è§†å›¾ (3D å¡ç‰‡) ---
    function renderStudy(container) {
      const list = state.wordLists.find(l => l.id === state.activeListId);
      const task = state.reviewTasks.find(t => t.id === state.activeTaskId);
      if (!list) return navigate('home');

      let currentIdx = 0;
      let flipped = false;

      const speak = (text) => {
        if (!state.settings.autoTTS) return;
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-US';
        u.rate = 0.95;
        window.speechSynthesis.speak(u);
      };

      const renderCard = () => {
        const word = list.words[currentIdx];
        const progress = ((currentIdx + 1) / list.words.length) * 100;
        
        container.innerHTML = `
          <div class="fixed inset-0 bg-[#F2F2F7] flex flex-col safe-area-top safe-area-bottom overflow-hidden">
            <header class="px-6 py-4 flex items-center justify-between ios-blur border-b border-[#C6C6C8]/30 z-50">
              <button id="exitStudy" class="text-[#007AFF] font-black text-lg">é€€å‡º</button>
              <div class="flex-1 px-10">
                <div class="h-2.5 bg-[#E5E5EA] rounded-full overflow-hidden">
                  <div class="h-full bg-[#34C759] transition-all duration-300" style="width: ${progress}%"></div>
                </div>
              </div>
              <span class="text-sm font-black text-[#8E8E93] tabular-nums">${currentIdx + 1}/${list.words.length}</span>
            </header>

            <div class="px-6 py-4 flex justify-center gap-4 bg-white/50">
              <button id="toggleTTS" class="px-4 py-2 rounded-full text-[12px] font-black uppercase transition-colors ${state.settings.autoTTS ? 'bg-[#007AFF] text-white' : 'bg-gray-300 text-gray-700'}">è‡ªåŠ¨å‘éŸ³</button>
              <button id="toggleOrder" class="px-4 py-2 rounded-full bg-gray-200 text-black text-[12px] font-black uppercase">${state.settings.showWordFirst ? 'å…ˆçœ‹å•è¯' : 'å…ˆçœ‹é‡Šä¹‰'}</button>
            </div>

            <div class="flex-1 flex items-center justify-center p-8 perspective-1000">
              <div id="flipCard" class="relative w-full max-w-[360px] aspect-[4/5] preserve-3d transition-transform duration-500 ease-in-out cursor-pointer ${flipped ? 'rotate-y-180' : ''}">
                <div class="absolute inset-0 bg-white rounded-[40px] ios-shadow flex flex-col items-center justify-center p-10 text-center backface-hidden border-2 border-[#C6C6C8]/20">
                   <span class="text-[12px] font-black text-[#C6C6C8] uppercase tracking-widest mb-10">${state.settings.showWordFirst ? 'å•è¯' : 'é‡Šä¹‰'}</span>
                   <h2 class="font-black leading-tight ${state.settings.showWordFirst ? 'text-5xl' : 'text-2xl text-review'}">${state.settings.showWordFirst ? word.word : word.definition}</h2>
                   <div class="mt-20 flex flex-col items-center opacity-30">
                     <svg class="w-8 h-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="3" d="M19 14l-7 7m0 0l-7-7m7 7V3"/></svg>
                     <span class="text-[11px] font-black uppercase tracking-widest">ç‚¹å‡»ç¿»è½¬</span>
                   </div>
                </div>
                <div class="absolute inset-0 bg-white rounded-[40px] ios-shadow flex flex-col items-center justify-center p-10 text-center backface-hidden border-2 border-[#C6C6C8]/20 rotate-y-180">
                   <span class="text-[12px] font-black text-[#C6C6C8] uppercase tracking-widest mb-10">${state.settings.showWordFirst ? 'é‡Šä¹‰' : 'å•è¯'}</span>
                   <h2 class="font-black leading-tight ${state.settings.showWordFirst ? 'text-2xl text-review' : 'text-5xl'}">${state.settings.showWordFirst ? word.definition : word.word}</h2>
                   <button id="cardSpeakBtn" class="mt-16 w-14 h-14 bg-[#007AFF]/10 rounded-full flex items-center justify-center text-[#007AFF]">
                     <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
                   </button>
                </div>
              </div>
            </div>

            <div class="px-12 pb-20 pt-8 flex items-center justify-around gap-12">
              <button id="btnWrong" class="w-24 h-24 rounded-full bg-white border-[6px] border-[#FF3B30]/20 flex items-center justify-center text-[#FF3B30] ios-shadow active:scale-90 transition-all">
                <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="4" d="M6 18L18 6M6 6l12 12"/></svg>
              </button>
              <button id="btnCorrect" class="w-28 h-28 rounded-full bg-[#34C759] flex items-center justify-center text-white ios-shadow active:scale-90 transition-all shadow-[0_12px_24px_rgba(52,199,89,0.4)]">
                <svg class="w-14 h-14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="5" d="M5 13l4 4L19 7"/></svg>
              </button>
            </div>
          </div>
        `;

        if (state.settings.autoTTS && state.settings.showWordFirst) speak(word.word);

        document.getElementById('exitStudy').onclick = () => { if(confirm("ç¡®å®šè¦é€€å‡ºå¤ä¹ å—ï¼Ÿå½“å‰è¿›åº¦ä¸ä¼šä¿å­˜ã€‚")) navigate('home'); };
        document.getElementById('toggleTTS').onclick = () => { state.settings.autoTTS = !state.settings.autoTTS; saveState(); renderCard(); };
        document.getElementById('toggleOrder').onclick = () => { state.settings.showWordFirst = !state.settings.showWordFirst; saveState(); renderCard(); };
        
        const flipCard = document.getElementById('flipCard');
        flipCard.onclick = () => {
          flipped = !flipped;
          flipCard.classList.toggle('rotate-y-180');
          if (flipped && !state.settings.showWordFirst && state.settings.autoTTS) speak(word.word);
        };
        
        const speakBtn = document.getElementById('cardSpeakBtn');
        if (speakBtn) {
          speakBtn.onclick = (e) => { e.stopPropagation(); speak(word.word); };
        }

        const handleNext = (known) => {
          const card = document.getElementById('flipCard');
          card.classList.add(known ? 'fly-right' : 'fly-left');
          setTimeout(() => {
            if (currentIdx < list.words.length - 1) {
              currentIdx++;
              flipped = false;
              renderCard();
            } else {
              if (task) task.status = 'completed';
              saveState();
              alert("å¤ªæ£’äº†ï¼ä½ å·²å®Œæˆæœ¬æ¬¡è¯å•çš„å­¦ä¹ ä»»åŠ¡ã€‚");
              navigate('home');
            }
          }, 350);
        };

        document.getElementById('btnWrong').onclick = () => handleNext(false);
        document.getElementById('btnCorrect').onclick = () => handleNext(true);
      };
      renderCard();
    }

    // --- 4. è¯åº“è§†å›¾ ---
    function renderLibrary(container) {
      container.innerHTML = `
        <div class="animate-in fade-in duration-300">
          <header class="px-6 pt-12 pb-5 flex justify-between items-center">
            <h1 class="text-5xl font-black">è¯åº“</h1>
            <button id="libAdd" class="w-12 h-12 bg-[#007AFF] text-white rounded-full flex items-center justify-center ios-shadow active:scale-90 transition-transform"><svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="3" d="M12 4v16m8-8H4"/></svg></button>
          </header>
          <div class="px-6 space-y-5 pb-40">
            ${state.wordLists.length > 0 ? state.wordLists.map(l => `
              <div class="bg-white rounded-[32px] p-7 ios-shadow active:scale-95 transition-transform border border-[#C6C6C8]/20" data-id="${l.id}">
                <div class="flex justify-between items-start">
                   <h3 class="font-black text-2xl text-black">${l.title}</h3>
                   <button class="delete-list text-[#FF3B30] p-2 bg-[#FF3B30]/10 rounded-full" data-id="${l.id}">
                     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2.5" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                   </button>
                </div>
                <p class="text-base font-bold text-[#8E8E93] mt-2 line-clamp-2">${l.description || 'æš‚æ— è¯¦ç»†æè¿°'}</p>
                <div class="mt-6 flex items-center text-[11px] font-black uppercase text-[#8E8E93] gap-4">
                  <span class="bg-[#F2F2F7] text-black px-3 py-1 rounded-full">${l.words.length} è¯æ±‡</span>
                  <span>åˆ›å»ºäº ${new Date(l.createdAt).toLocaleDateString()}</span>
                </div>
              </div>
            `).join('') : '<div class="py-24 text-center opacity-30 font-black text-2xl">è¯åº“ç©ºç©ºå¦‚ä¹Ÿ</div>'}
          </div>
        </div>
      `;
      document.getElementById('libAdd').onclick = () => navigate('add');
      container.querySelectorAll('.delete-list').forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          if(confirm("ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™ä¸ªè¯å•å—ï¼Ÿç›¸å…³å¤ä¹ è®°å½•ä¹Ÿå°†è¢«æŠ¹é™¤ã€‚")) {
            state.wordLists = state.wordLists.filter(l => l.id !== btn.dataset.id);
            state.reviewTasks = state.reviewTasks.filter(t => t.listId !== btn.dataset.id);
            saveState();
            renderLibrary(container);
          }
        };
      });
    }

    // --- Tab Bar ---
    function createTabBar() {
      const bar = document.createElement('nav');
      bar.className = 'fixed bottom-0 left-0 right-0 ios-blur border-t border-[#C6C6C8]/40 safe-area-bottom h-20 flex items-center justify-around z-50';
      bar.innerHTML = `
        <button id="tabHome" class="flex flex-col items-center flex-1 transition-all ${state.view === 'home' ? 'text-[#007AFF] scale-110' : 'text-[#8E8E93]'}">
          <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24"><path d="M12 3L4 9v12h5v-7h6v7h5V9z"/></svg>
          <span class="text-[11px] font-black mt-1">å­¦ä¹ è®¡åˆ’</span>
        </button>
        <button id="tabLib" class="flex flex-col items-center flex-1 transition-all ${state.view === 'library' ? 'text-[#007AFF] scale-110' : 'text-[#8E8E93]'}">
          <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24"><path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z"/></svg>
          <span class="text-[11px] font-black mt-1">æˆ‘çš„è¯åº“</span>
        </button>
      `;
      bar.querySelector('#tabHome').onclick = () => navigate('home');
      bar.querySelector('#tabLib').onclick = () => navigate('library');
      return bar;
    }

    // å¯åŠ¨åº”ç”¨
    render();
  </script>
</body>
</html>
